import * as tslib_1 from "tslib";
import { HTTPRequestEncoder, HTTPResponseDecoder, PREFIX, BasementClientError, ErrorName, ErrorType, } from '@ant-basement/core';
import crypto from 'crypto-js';
import { isNumber } from 'util';
var MiniProgramHTTPRequestEncoder = (function (_super) {
    tslib_1.__extends(MiniProgramHTTPRequestEncoder, _super);
    function MiniProgramHTTPRequestEncoder(endpoint, spaceId) {
        var _this = _super.call(this, endpoint) || this;
        _this.spaceId = spaceId;
        _this.prefix = PREFIX.CLIENT;
        _this.serviceHeaders = {};
        _this.setBodyField({
            spaceId: spaceId,
        });
        return _this;
    }
    MiniProgramHTTPRequestEncoder.prototype.sign = function (clientSecret) {
        var _a = this.body, spaceId = _a.spaceId, method = _a.method, params = _a.params, token = _a.token, userId = _a.userId;
        var timestamp = Date.now();
        this.setBodyField({
            timestamp: timestamp,
        });
        var signString = '';
        var signObject = {
            spaceId: spaceId,
            timestamp: timestamp,
            method: method,
            params: JSON.stringify(params),
            token: token,
            userId: userId,
        };
        Object.keys(signObject).sort().forEach(function (key) {
            if (signObject[key]) {
                signString = signString + "&" + key + "=" + signObject[key];
            }
        });
        signString = signString.slice(1);
        var sign = crypto.HmacMD5(signString, clientSecret).toString(crypto.enc.Hex);
        this.setServerlessHeaders({ sign: sign });
    };
    MiniProgramHTTPRequestEncoder.prototype.encodeAsHTTPRequestObject = function (additionalObject) {
        if (this.body.params) {
            this.body.params = JSON.stringify(this.body.params);
        }
        return tslib_1.__assign({ url: this.url, data: this.body, method: this.method, headers: this.headers, dataType: 'json' }, additionalObject);
    };
    MiniProgramHTTPRequestEncoder.prototype.clone = function () {
        var encoder = new MiniProgramHTTPRequestEncoder(this.endpoint, this.spaceId);
        encoder.setBodyField(this.body);
        encoder.setBaseHeaders(this.baseHeaders);
        encoder.setServerlessHeaders(this.serverlessHeaders);
        return encoder;
    };
    return MiniProgramHTTPRequestEncoder;
}(HTTPRequestEncoder));
export { MiniProgramHTTPRequestEncoder };
var MiniProgramHTTPResponseDecoder = (function (_super) {
    tslib_1.__extends(MiniProgramHTTPResponseDecoder, _super);
    function MiniProgramHTTPResponseDecoder() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.ERROR_CODES = [11, 12, 13, 14, 19, 20];
        return _this;
    }
    MiniProgramHTTPResponseDecoder.prototype.setStatusAndBody = function (status, body) {
        _super.prototype.setStatusAndBody.call(this, status, body);
        if (this.ERROR_CODES.includes(status)) {
            this._error = BasementClientError.from({
                name: ErrorName.IDE_ERROR,
                code: status.toString(),
                type: ErrorType.IDE_ERROR,
                message: 'request error from Alipay IDE',
            });
        }
    };
    MiniProgramHTTPResponseDecoder.prototype.decode = function (res) {
        this.setHeaders(res.headers || {});
        var body = res.data || res.body;
        if (typeof body === 'string') {
            body = JSON.parse(body);
        }
        if (body && body.data) {
            if (isNumber(body.data.affectedDocs)) {
                body = Object.assign({}, body, tslib_1.__assign({}, body.data));
            }
            else if (Object.prototype.toString.call(body.data) === '[object Object]') {
                body.result = Object.assign({}, body.data);
            }
            else if (Object.prototype.toString.call(body.data) === '[object Array]') {
                body.result = body.data.slice(0);
            }
            else {
                body.result = body.data;
            }
            delete body.data;
        }
        var responseErrorCode = parseInt(res.error, 10);
        if (responseErrorCode) {
            this.setStatusAndBody(responseErrorCode, body);
            return _super.prototype.decode.call(this);
        }
        var responseErrorMessage = res.err;
        if (responseErrorMessage) {
            this.setErrorMessage(responseErrorMessage);
            return _super.prototype.decode.call(this);
        }
        if (res instanceof Error) {
            this.setErrorObject(res);
            return _super.prototype.decode.call(this);
        }
        if (body && typeof body.error === 'object') {
            this.setErrorObject(body.error);
            return _super.prototype.decode.call(this);
        }
        var responseStatusCode = parseInt(res.status || res.statusCode, 10);
        if (responseStatusCode) {
            this.setStatusAndBody(responseStatusCode, body);
            return _super.prototype.decode.call(this);
        }
        this.setStatusAndBody(200, res);
        return _super.prototype.decode.call(this);
    };
    return MiniProgramHTTPResponseDecoder;
}(HTTPResponseDecoder));
export { MiniProgramHTTPResponseDecoder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29kZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFFTCxrQkFBa0IsRUFFbEIsbUJBQW1CLEVBRW5CLE1BQU0sRUFDTixtQkFBbUIsRUFDbkIsU0FBUyxFQUNULFNBQVMsR0FDVixNQUFNLG9CQUFvQixDQUFDO0FBQzVCLE9BQU8sTUFBTSxNQUFNLFdBQVcsQ0FBQztBQUMvQixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBb0JoQztJQUFtRCx5REFBa0I7SUFTbkUsdUNBQVksUUFBZ0IsRUFBWSxPQUFlO1FBQXZELFlBQ0Usa0JBQU0sUUFBUSxDQUFDLFNBS2hCO1FBTnVDLGFBQU8sR0FBUCxPQUFPLENBQVE7UUFSN0MsWUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDdkIsb0JBQWMsR0FBMEIsRUFBRSxDQUFDO1FBVW5ELEtBQUksQ0FBQyxZQUFZLENBQUM7WUFDaEIsT0FBTyxTQUFBO1NBQ1IsQ0FBQyxDQUFDOztJQUNMLENBQUM7SUFNTSw0Q0FBSSxHQUFYLFVBQVksWUFBb0I7UUFDeEIsSUFBQSxjQUFzRCxFQUFwRCxvQkFBTyxFQUFFLGtCQUFNLEVBQUUsa0JBQU0sRUFBRSxnQkFBSyxFQUFFLGtCQUFvQixDQUFDO1FBQzdELElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsWUFBWSxDQUFDO1lBQ2hCLFNBQVMsV0FBQTtTQUNWLENBQUMsQ0FBQztRQUNILElBQUksVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFNLFVBQVUsR0FBRztZQUNqQixPQUFPLFNBQUE7WUFDUCxTQUFTLFdBQUE7WUFDVCxNQUFNLFFBQUE7WUFDTixNQUFNLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7WUFDOUIsS0FBSyxPQUFBO1lBQ0wsTUFBTSxRQUFBO1NBQ1AsQ0FBQztRQUNGLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRztZQUN4QyxJQUFJLFVBQVUsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDbkIsVUFBVSxHQUFNLFVBQVUsU0FBSSxHQUFHLFNBQUksVUFBVSxDQUFDLEdBQUcsQ0FBRyxDQUFDO2FBQ3hEO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxVQUFVLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQyxJQUFNLElBQUksR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxZQUFZLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsRUFBRSxJQUFJLE1BQUEsRUFBRSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQU9NLGlFQUF5QixHQUFoQyxVQUFpQyxnQkFBb0M7UUFDbkUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDckQ7UUFDRCwwQkFDRSxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFDYixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksRUFDZixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFDbkIsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQ3JCLFFBQVEsRUFBRSxNQUFNLElBQ2IsZ0JBQWdCLEVBQ25CO0lBQ0osQ0FBQztJQU1NLDZDQUFLLEdBQVo7UUFDRSxJQUFNLE9BQU8sR0FBRyxJQUFJLDZCQUE2QixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQy9FLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hDLE9BQU8sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUNyRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBQ0gsb0NBQUM7QUFBRCxDQUFDLEFBNUVELENBQW1ELGtCQUFrQixHQTRFcEU7O0FBRUQ7SUFBb0QsMERBQW1CO0lBQXZFO1FBQUEscUVBcUZDO1FBcEZXLGlCQUFXLEdBQUcsQ0FBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBRSxDQUFDOztJQW9GckQsQ0FBQztJQTlFUSx5REFBZ0IsR0FBdkIsVUFBd0IsTUFBYyxFQUFFLElBQVM7UUFDL0MsaUJBQU0sZ0JBQWdCLFlBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRXJDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDckMsSUFBSSxDQUFDLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUM7Z0JBQ3JDLElBQUksRUFBRSxTQUFTLENBQUMsU0FBUztnQkFDekIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUU7Z0JBQ3ZCLElBQUksRUFBRSxTQUFTLENBQUMsU0FBUztnQkFDekIsT0FBTyxFQUFFLCtCQUErQjthQUN6QyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7SUFPTSwrQ0FBTSxHQUFiLFVBQWMsR0FBdUI7UUFDbkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ25DLElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQztRQUVoQyxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUM1QixJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN6QjtRQUVELElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDckIsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRTtnQkFFcEMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksdUJBQ3hCLElBQUksQ0FBQyxJQUFJLEVBQ1osQ0FBQzthQUNKO2lCQUFNLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxpQkFBaUIsRUFBRTtnQkFFMUUsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDNUM7aUJBQU0sSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLGdCQUFnQixFQUFFO2dCQUV2RSxnQ0FBYyxDQUFlO2FBQ2hDO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQzthQUN6QjtZQUNELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztTQUNsQjtRQUdELElBQU0saUJBQWlCLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDbEQsSUFBSSxpQkFBaUIsRUFBRTtZQUNyQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDL0MsT0FBTyxpQkFBTSxNQUFNLFdBQUUsQ0FBQztTQUN2QjtRQUVELElBQU0sb0JBQW9CLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQztRQUNyQyxJQUFJLG9CQUFvQixFQUFFO1lBQ3hCLElBQUksQ0FBQyxlQUFlLENBQUMsb0JBQW9CLENBQUMsQ0FBQztZQUMzQyxPQUFPLGlCQUFNLE1BQU0sV0FBRSxDQUFDO1NBQ3ZCO1FBRUQsSUFBSSxHQUFHLFlBQVksS0FBSyxFQUFFO1lBQ3hCLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDekIsT0FBTyxpQkFBTSxNQUFNLFdBQUUsQ0FBQztTQUN2QjtRQUVELElBQUksSUFBSSxJQUFJLE9BQU8sSUFBSSxDQUFDLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDMUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEMsT0FBTyxpQkFBTSxNQUFNLFdBQUUsQ0FBQztTQUN2QjtRQUdELElBQU0sa0JBQWtCLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN0RSxJQUFJLGtCQUFrQixFQUFFO1lBQ3RCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNoRCxPQUFPLGlCQUFNLE1BQU0sV0FBRSxDQUFDO1NBQ3ZCO1FBR0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNoQyxPQUFPLGlCQUFNLE1BQU0sV0FBRSxDQUFDO0lBQ3hCLENBQUM7SUFDSCxxQ0FBQztBQUFELENBQUMsQUFyRkQsQ0FBb0QsbUJBQW1CLEdBcUZ0RSJ9